diff --git a/HTMLparser.c b/HTMLparser.c
index 91266f20..13d49574 100644
--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3574,7 +3574,7 @@ next_chunk:
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
 
-        if (extraSize > buffer_size) {
+        if (extraSize > buffer_size - used) {
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
